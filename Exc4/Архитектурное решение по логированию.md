# Архитектурное решение по логированию
Считаю, что нужно собирать логи, связанные с любым изменением заказа
из систем MES API, shop API, CRM API. Так же думаю, что целесообразно будет
логировать начало и завершение обработки запроса в этих системах.

Дополнительно в системах CRM API и MES API нужно логировать прием/отправку сообщений в очередь.

В общем, было бы полезно внедрить как можно больше логов с уровнем DEBUG, это существенно облегчает расследование
ошибок и аномалий в поведении системы.

## Список необходимых логов с уровнем INFO
1. Изменение статуса заказа. Логируем ИД окружения, время, идентификатор пользователя, номер заказа.
2. API получило запрос. Логируем ИД окружения, время, идентификатор пользователя, основные данные из входящего payload.
3. API обработало запрос. Логируем ИД окружения, время, идентификатор пользователя, основные данные из входящего payload.
4. CRM API/MES API получило/отправило сообщение в очередь. Логируем ИД окружения, время, payload.

В dev окружении будем использовать уровень логирования DEBUG. В release/prod окружениях
в критических ситуациях так же можно периодически использовать этот уровень логирования.

## Мотивация
Внедрение логирования в система позволит:
1. Упростит отладку разных компонентов приложения;
2. Собирать и анализировать данные о работе системы;
3. Упростит и ускорит поиск ошибок;
4. Повысит надежность системы;
5. Выявлять узкие места и повышать производительность системы.

В первую очередь трейсинг необходимо внедрять в MES API и CRM API, так как на текущем этапе процессы, происходящие в этих системах,
наиболее непрозрачны и запутаны. Так же неопределенности добавляет очередь сообщений, через которую взаимодействую эти части системы.

Для Shop API на текущем этапе можно ограничиться внедрением логирования, т. к., на мой взгляд,
процессы, происходящие в этой части системы более интуитивно понятны и менее запутаны.

## Предлагаемое решение
Для реализации логирования будем использовать стэк Beats -> Vector -> Grafana Loki -> Grafana (т.к. в АС уже используется Grafana для мониторинга).
```markdown
[С4 диаграмма] (https://disk.yandex.ru/d/u2LgUsxC8SPDpA)
```

### Политика безопасности
Необходимо добавить аутентиикацию, чтобы в Grafana UI вход был доступен только
сотрудникам компании с актуальной учетной записью и ролью "поддержка" или "разработка".
Так же в идеале было бы неплохо ограничить доступ пользователям, находящимся вне корпоративной сети.

### Политика хранения логов
Т.к., согласно описанию задачи и выявленных проблем, выполнение одного заказа может
занимать несколько месяцев, целесообразно хранить лог файлы в течение года для того, чтобы была возможность
провести расследование/анализ возникших ошибок.

### Система анализа логов
Для начала настроим несколько базовых алертов, которые помогут при стандартных внештатных ситуациях:
1. Резкий рост числа запросов на создание новых заказов. (мне кажется для начала >100 в секунду)
2. Увеличение среднего времени рассчета стоимости заказа MES API (например если стреднее значение стало больше 30 мин за последние 3 часа)
3. Превышение размера загружаемого файла эскиза некоторого среднего значения (которое предстоит вычислить) 
